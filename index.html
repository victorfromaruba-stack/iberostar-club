<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <!-- VIEWPORT: Optimized for iPad/Mobile to prevent layout shifting -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <!-- APPLE PWA SETTINGS -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Iberostar Aruba">
    
    <!-- ICONS -->
    <link rel="apple-touch-icon" href="Logos/app_logo_club.png?v=2"> 
    <link rel="shortcut icon" href="Logos/app_logo_club.png?v=2" type="image/png">
    
    <!-- FONTS -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Playfair+Display:ital,wght@0,600;0,700;1,600&display=swap" rel="stylesheet">

    <title>Iberostar Aruba</title>

    <!-- CRITICAL: Image Error Handler -->
    <script>
        // This function cleans up the DOM by removing broken image containers entirely
        function handleImgError(img) {
            if (window.handleImgError && window.handleImgError !== handleImgError) return;
            if (!img.src) return;
            if (img.getAttribute('data-tried-fix')) return;
            
            img.setAttribute('data-tried-fix', 'true'); 
            const src = img.src;
            
            // 1. Try common extensions first
            if (src.endsWith('.jpg') || src.endsWith('.png') || src.endsWith('.webp')) {
                if(src.endsWith('.jpg')) img.src = src.replace('.jpg', '.png');
                else if(src.endsWith('.png')) img.src = src.replace('.png', '.jpg');
            } else {
                // 2. If it fails, REMOVE the parent container.
                // This ensures the DOM only contains Valid images.
                const galleryItem = img.closest('.gallery-item');
                if (galleryItem) {
                    galleryItem.remove(); 
                }
                else {
                    img.style.display = 'none';
                }
            }
        }
        
        // Helper to fade in images only when they are ready (prevents broken icon flicker)
        function imgLoaded(img) {
            img.classList.add('loaded');
        }
    </script>

    <style>
        /* --- 2026 MASTERMIND SYSTEM --- */
        :root {
            --bg-gradient-1: #4facfe;
            --bg-gradient-2: #00f2fe;
            --ocean-deep: #0F2D4A; 
            --gold: #C5A065;
            --glass-card: rgba(255, 255, 255, 0.8);
            --glass-nav: rgba(255, 255, 255, 0.85);
            --glass-border: rgba(255, 255, 255, 0.6);
            --text-main: #0F2D4A;
            --text-muted: #425b76;
            --font-head: 'Playfair Display', serif;
            --font-body: 'Inter', sans-serif;
            --ease-out: cubic-bezier(0.2, 0.8, 0.2, 1);
        }

        body.dark-theme {
            --text-main: #FFFFFF;
            --text-muted: rgba(255, 255, 255, 0.8);
            --glass-card: rgba(15, 23, 42, 0.6);
            --glass-nav: rgba(15, 23, 42, 0.85);
            --glass-border: rgba(255, 255, 255, 0.1);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        
        body {
            margin: 0;
            font-family: var(--font-body);
            background-color: #FDFBF7;
            color: var(--text-main);
            height: 100vh;
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
            padding-left: env(safe-area-inset-left);
            padding-right: env(safe-area-inset-right);
            display: flex;
            overflow: hidden;
            background: linear-gradient(180deg, var(--bg-gradient-1) 0%, var(--bg-gradient-2) 100%);
            transition: background 2.5s ease;
        }

        /* Prevent image flashing - Images start invisible and fade in */
        img { opacity: 0; transition: opacity 0.4s ease; }
        img.loaded { opacity: 1; }

        /* --- BACKGROUND LAYERS --- */
        .ocean-waves {
            position: absolute; inset: 0; pointer-events: none; z-index: 0;
            background-image: url("data:image/svg+xml,%3Csvg width='100' height='20' viewBox='0 0 100 20' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M21.184 20c.357-.13.72-.264 1.088-.402l1.768-.661C33.64 15.347 39.647 14 50 14c10.271 0 15.362 1.222 24.629 4.928.955.383 1.869.74 2.75 1.072h6.225c-2.51-.73-5.139-1.691-8.233-2.928C65.888 13.278 60.562 12 50 12c-10.626 0-16.855 1.397-26.66 5.063l-1.767.662c-2.475.923-4.66 1.674-6.724 2.275h6.335zm0-20C13.258 2.892 8.077 4 0 4V2c5.744 0 9.951-.574 14.85-2h6.334zM77.38 0C85.239 2.966 90.502 4 100 4V2c-6.842 0-11.386-.542-16.396-2h-6.225zM0 14c8.44 0 13.718-1.21 22.272-4.402l1.768-.661C33.64 5.347 39.647 4 50 4c10.271 0 15.362 1.222 24.629 4.928C84.112 12.722 89.438 14 100 14v-2c-10.271 0-15.362-1.222-24.629-4.928C65.888 3.278 60.562 2 50 2 39.374 2 33.145 3.397 23.34 7.063l-1.767.662C13.223 10.84 8.163 12 0 12v2z' fill='%23ffffff' fill-opacity='0.05' fill-rule='evenodd'/%3E%3C/svg%3E");
            opacity: 0.2; animation: waveDrift 60s linear infinite;
        }
        @keyframes waveDrift { 0% { background-position: 0 0; } 100% { background-position: 1000px 20px; } }

        .palm-shadows {
            position: absolute; inset: 0; pointer-events: none; z-index: 1;
            background: radial-gradient(circle at 100% 0%, rgba(0,0,0,0.05) 0%, transparent 40%),
                        radial-gradient(circle at 90% 10%, rgba(0,0,0,0.03) 0%, transparent 30%);
            opacity: 0; transition: opacity 3s ease; filter: blur(40px);
        }
        .shadows-active { opacity: 1 !important; animation: palmSway 10s ease-in-out infinite alternate; }
        @keyframes palmSway { 0% { transform: translateX(0); } 100% { transform: translateX(-20px); } }

        .night-glow {
            position: absolute; bottom: 0; left: 0; width: 100%; height: 60vh;
            background: linear-gradient(to top, rgba(212, 175, 55, 0.15), transparent);
            opacity: 0; transition: opacity 3s ease; z-index: 0; pointer-events: none;
        }
        .glow-active { opacity: 1 !important; }

        .clouds {
            position: absolute; top: 0; left: 0; width: 100%; height: 300px;
            background-image: radial-gradient(rgba(255,255,255,0.4) 1px, transparent 1px);
            background-size: 60px 60px; filter: blur(40px);
            opacity: 0; transition: opacity 3s ease; z-index: 0;
            animation: cloudDrift 90s linear infinite;
        }
        .clouds-active { opacity: 0.7 !important; }
        @keyframes cloudDrift { 0% { transform: translateX(-30px); } 50% { transform: translateX(30px); } 100% { transform: translateX(-30px); } }

        /* --- LAYOUT & COMPONENTS --- */
        nav {
            width: 90px; height: 94vh; margin: 3vh 0 3vh 3vh;
            background: var(--glass-nav); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border-radius: 40px; display: flex; flex-direction: column; align-items: center; justify-content: center;
            border: 1px solid var(--glass-border); z-index: 100;
            padding-bottom: env(safe-area-inset-bottom);
        }
        .nav-btn {
            width: 60px; height: 60px; border-radius: 20px; margin-bottom: 20px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            background: transparent; border: none; color: var(--text-muted); cursor: pointer;
            transition: all 0.4s var(--ease-out);
        }
        .nav-btn.active { background: var(--gold); color: white; animation: spring 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes spring { 0% { transform: scale(0.9); } 100% { transform: scale(1); } }
        .nav-btn svg { width: 28px; height: 28px; fill: currentColor; transition: transform 0.4s; pointer-events: none; }
        .nav-btn.active svg { transform: scale(1.1); fill: white; }

        main { 
            flex: 1; height: 100vh; overflow-y: auto; overflow-x: hidden; padding: 50px 70px; 
            scroll-behavior: smooth; z-index: 10; -webkit-overflow-scrolling: touch;
        }

        .header-logo { height: 80px; width: auto; cursor: pointer; mix-blend-mode: normal; transition: filter 0.5s; object-fit: contain; }
        .logo-white { filter: brightness(0) invert(1); }

        .greeting { font-family: var(--font-body); font-size: 0.9rem; text-transform: uppercase; letter-spacing: 2px; color: var(--gold); font-weight: 800; }
        .date-display { font-family: var(--font-body); font-size: 1rem; color: var(--text-muted); margin-top: 4px; font-weight: 500; }
        body.dark-theme .date-display { color: rgba(255,255,255,0.7); }

        h1 { 
            font-family: var(--font-head); font-size: 4rem; font-weight: 700; color: var(--text-main); margin: 0; letter-spacing: -1px; 
            position: relative; display: inline-block;
        }
        .subtitle { font-family: var(--font-body); font-size: 1.4rem; color: var(--text-muted); margin-top: 10px; max-width: 600px; font-weight: 300; }
        body.dark-theme .subtitle { color: rgba(255,255,255,0.7); }

        .search-container { margin-top: 35px; position: relative; max-width: 500px; display: none; }
        .search-input {
            width: 100%; padding: 20px 24px 20px 60px; border-radius: 24px;
            border: 1px solid var(--glass-border); background: var(--glass-card);
            backdrop-filter: blur(20px); font-size: 1.1rem; color: var(--text-main); font-family: var(--font-body);
        }
        .search-icon { position: absolute; left: 24px; top: 50%; transform: translateY(-50%); width: 22px; height: 22px; fill: var(--gold); pointer-events: none; }

        /* GRID & CARDS */
        .grid { 
            display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 35px; padding-bottom: 120px; perspective: 1000px; 
            opacity: 0; transform: translateY(20px); transition: opacity 0.6s ease, transform 0.6s ease;
        }
        .grid.loaded { opacity: 1; transform: translateY(0); }

        .card {
            background: var(--glass-card); backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border); border-radius: 30px;
            overflow: hidden; position: relative; cursor: pointer;
            transition: transform 0.1s ease;
            box-shadow: 0 15px 35px rgba(15, 45, 74, 0.1);
            transform-style: preserve-3d;
        }
        .card:active { transform: scale(0.98); }
        .card-media { height: 220px; position: relative; overflow: hidden; pointer-events: none; }
        .card-img { width: 100%; height: 100%; object-fit: cover; }
        
        .tag-pill {
            position: absolute; top: 18px; left: 18px;
            background: rgba(255,255,255,0.95); padding: 6px 14px; border-radius: 12px;
            font-size: 0.7rem; font-weight: 800; text-transform: uppercase; font-family: var(--font-body);
            color: #0F2D4A; z-index: 2;
        }
        .tag-pill.highlight { background: var(--gold); color: white; }

        .card-content { padding: 25px 28px; pointer-events: none; }
        .card-title { font-family: var(--font-head); font-size: 1.6rem; font-weight: 700; color: var(--text-main); margin: 0 0 6px 0; }
        .card-desc { font-family: var(--font-body); font-size: 0.95rem; color: var(--text-muted); line-height: 1.5; margin: 0; }
        body.dark-theme .card-desc { color: rgba(255,255,255,0.7); }

        /* --- SPLASH SCREEN --- */
        #splash { position: fixed; inset: 0; z-index: 9999; background: #fff; display: flex; align-items: center; justify-content: center; transition: opacity 0.8s ease; }
        .splash-logo { width: 450px; max-width: 85%; animation: logoPulse 2s ease-in-out infinite alternate; }
        @keyframes logoPulse { 0% { transform: scale(1); } 100% { transform: scale(1.03); } }

        /* --- MODAL & GALLERY --- */
        .modal-wrap {
            position: fixed; inset: 0; z-index: 1000;
            background: rgba(15, 45, 74, 0.01); backdrop-filter: blur(0px);
            pointer-events: none; transition: all 0.5s var(--ease-out);
            display: flex; align-items: center; justify-content: center;
        }
        .modal-wrap.active { background: rgba(15, 45, 74, 0.4); backdrop-filter: blur(20px); pointer-events: all; }

        .modal {
            width: 85vw; height: 90vh; background: #fff; border-radius: 40px;
            display: flex; flex-direction: column; overflow: hidden; 
            transform: translateY(100vh) scale(0.95); transition: transform 0.5s cubic-bezier(0.19, 1, 0.22, 1);
        }
        body.dark-theme .modal { background: #1a1a1a; border: 1px solid rgba(255,255,255,0.1); }
        .modal-wrap.active .modal { transform: translateY(0) scale(1); }

        .modal-hero { height: 45vh; flex-shrink: 0; position: relative; cursor: pointer; }
        .modal-hero img { width: 100%; height: 100%; object-fit: cover; }
        
        .modal-content { flex: 1; padding: 40px 60px; overflow-y: auto; background: #fff; -webkit-overflow-scrolling: touch; }
        body.dark-theme .modal-content { background: #1a1a1a; }

        .gallery-scroller { display: flex; gap: 20px; overflow-x: auto; padding-bottom: 20px; margin-top: 40px; scroll-snap-type: x mandatory; -webkit-overflow-scrolling: touch; }
        .gallery-item {
            scroll-snap-align: start; width: 260px; height: 180px; flex-shrink: 0;
            border-radius: 20px; overflow: hidden; cursor: pointer;
            box-shadow: 0 8px 20px rgba(0,0,0,0.08); transition: transform 0.3s;
            position: relative; background: #f0f0f0; /* placeholder bg */
        }
        .gallery-item img { width: 100%; height: 100%; object-fit: cover; }

        /* --- LIGHTBOX VIEWER --- */
        .fs-viewer { 
            position: fixed; inset: 0; z-index: 1100; background: #000; 
            display: none; align-items: center; justify-content: center; 
        }
        .fs-viewer.active { display: flex; animation: fadeIn 0.3s; }
        
        .fs-image { 
            max-width: 100%; max-height: 100%; object-fit: contain; 
            box-shadow: 0 20px 50px rgba(0,0,0,0.5); opacity: 0; animation: scaleInFs 0.4s forwards; 
        }
        @keyframes scaleInFs { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        
        .fs-close { 
            position: absolute; top: 30px; right: 30px; color: white; 
            background: rgba(255,255,255,0.2); width: 60px; height: 60px; border-radius: 50%; 
            font-size: 32px; border:none; cursor: pointer; z-index: 1200; backdrop-filter: blur(10px);
            display: flex; align-items: center; justify-content: center;
        }

        .fs-nav {
            position: absolute; top: 50%; transform: translateY(-50%);
            width: 60px; height: 60px; border-radius: 50%;
            background: rgba(255,255,255,0.15); border: 1px solid rgba(255,255,255,0.2);
            color: white; font-size: 30px; cursor: pointer; z-index: 1200; backdrop-filter: blur(10px);
            display: flex; align-items: center; justify-content: center;
        }
        .fs-prev { left: 30px; } .fs-next { right: 30px; }

        .fs-caption {
            position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%);
            color: rgba(255,255,255,0.9); font-family: var(--font-body); font-size: 15px; font-weight: 600;
            background: rgba(0,0,0,0.5); padding: 8px 16px; border-radius: 20px; backdrop-filter: blur(5px);
        }

        /* MOBILE ADJUSTMENTS */
        @media (max-width: 768px) { 
            .fs-nav { width: 50px; height: 50px; font-size: 24px; } 
            .fs-prev { left: 10px; } .fs-next { right: 10px; } 
            nav { width: 92%; height: 70px; padding-bottom: env(safe-area-inset-bottom); bottom: 20px; position: fixed; margin: 0 0 20px 4%; }
            main { padding: 30px 20px 140px 20px; }
            h1 { font-size: 2.5rem; }
            .modal { width: 100%; height: 100%; border-radius: 0; top: 0; left: 0; transform: translateY(100vh); }
            .modal-wrap.active .modal { transform: translateY(0); }
            .modal-hero { height: 35vh; }
            .modal-content { padding: 30px 25px; }
        }
        
        .no-results { grid-column: 1/-1; text-align: center; padding: 60px; color: var(--text-muted); font-size: 1.2rem; display: none; }
    </style>
</head>
<body>

    <!-- BACKGROUND LAYERS -->
    <div class="ocean-waves"></div>
    <div class="palm-shadows" id="palmShadows"></div>
    <div class="night-glow" id="nightGlow"></div>
    <div class="clouds" id="clouds"></div>
    
    <!-- SPLASH SCREEN -->
    <div id="splash">
        <!-- UPDATED SPLASH LOGO -->
        <img id="splashLogo" src="Logos/logo_club.png" alt="Iberostar Aruba" class="splash-logo" onload="imgLoaded(this)">
    </div>

    <!-- MAIN APP STRUCTURE -->
    <nav>
        <button class="nav-btn active" onclick="nav('portfolio')"><svg viewBox="0 0 24 24"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg></button>
        <button class="nav-btn" onclick="nav('dining')"><svg viewBox="0 0 24 24"><path d="M11 9H9V2H7v7H5V2H3v7c0 2.12 1.66 3.84 3.75 3.97V22h2.5v-9.03C11.34 12.84 13 11.12 13 9V2h-2v7zm5-3v8h2.5v8H21V2c-2.76 0-5 2.24-5 4z"/></svg></button>
        <button class="nav-btn" onclick="nav('activities')"><svg viewBox="0 0 24 24"><path d="M13.5 5.5c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zM9.8 8.9L7 23h2.1l1.8-8 2.1 2v6h2v-7.5l-2.1-2 .6-3C14.8 12 16.8 13 19 13v-2c-1.9 0-3.5-1-4.3-2.4l-1-1.6c-.4-.6-1-1-1.7-1-.3 0-.5.1-.8.1L6 8.3V13h2V9.6l1.8-.7"/></svg></button>
        <button class="nav-btn" onclick="nav('spa')"><svg viewBox="0 0 24 24"><path d="M12 2C9 7 4 9 4 14c0 3 3 5 8 5s8-2 8-5c0-5-5-7-8-12zm0 18c-4.4 0-8-1.8-8-5 0-2.4 2.3-4.5 5-5.8 1.5 1.7 3 3.4 3 5.8 0-2.4 1.5-4.1 3-5.8 2.7 1.3 5 3.4 5 5.8 0 3.2-3.6 5-8 5z"/></svg></button>
        <button class="nav-btn" onclick="nav('golf')"><svg viewBox="0 0 24 24"><path d="M19.5 19.5c-1 0-1.7-.6-2.1-1.5l-2.9-6.2c-.2-.4-.3-.8-.3-1.3 0-.2 0-.4.1-.6l.5-1.9c.2-.8-.2-1.7-1-2L12 5.5c-.1 0-.2-.1-.3-.1-1 0-1.8.7-2 1.7l-.3 1.7c-.2.9-.9 1.6-1.8 1.9l-2.1.6C4.7 11.6 4 12.4 4 13.3v.2c0 1 .6 1.9 1.5 2.3l2.2.9c.8.3 1.3 1.1 1.3 1.9v1.1c0 1.5 1.2 2.8 2.8 2.8h5.9c1 0 1.8-.8 1.8-1.8v-1.2zm-10-17c1.1 0 2 .9 2 2s-.9 2-2 2-2-.9-2-2 .9-2 2-2z"/></svg></button>
    </nav>

    <main id="mainContainer">
        <header>
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <img id="headerLogo" src="Logos/logo_club.png" class="header-logo" onload="imgLoaded(this)" onerror="handleImgError(this)">
                <div style="text-align:right;">
                    <div class="greeting" id="greeting">Bon Bini</div>
                    <div class="date-display" id="dateDisplay">...</div>
                </div>
            </div>
            
            <h1 id="pageTitle" style="margin-top:20px;">Iberostar Aruba</h1>
            <p class="subtitle" id="pageSub">The official guide to redeeming Iberocash on Aruba.</p>
            
            <div class="search-container" id="searchBox">
                <svg class="search-icon" viewBox="0 0 24 24"><path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg>
                <input type="text" id="searchInput" class="search-input" placeholder="Search..." onkeyup="filterContent()">
            </div>
        </header>

        <div id="appContent"></div>
    </main>

    <!-- MODAL -->
    <div class="modal-wrap" id="detailModal">
        <div class="modal">
            <button class="modal-close-btn" onclick="closeModal()">✕</button>
            <div class="modal-hero" onclick="openLightboxFromHero()">
                <img id="dImg" src="" onload="imgLoaded(this)" onerror="handleImgError(this)">
                <div style="position:absolute; bottom:20px; right:20px; background:rgba(255,255,255,0.8); padding:6px 12px; border-radius:20px; font-weight:700; font-size:11px;">TAP TO EXPAND</div>
            </div>
            <div class="modal-content">
                <h2 id="dTitle" style="margin:0;">Title</h2>
                <span id="dSub" style="color:var(--gold); font-weight:700; text-transform:uppercase; font-size:0.9rem;">Subtitle</span>
                <p id="dDesc" style="margin-top:15px; font-size:1.1rem; line-height:1.6; color:var(--text-muted);">Desc</p>
                
                <div id="dDetails"></div>
                
                <h4 style="margin-top:40px; font-family:var(--font-head); font-size:1.5rem;">Gallery</h4>
                <div class="gallery-scroller" id="dGallery"></div>
            </div>
        </div>
    </div>

    <!-- LIGHTBOX -->
    <div class="fs-viewer" id="fsViewer">
        <button class="fs-close" onclick="closeFs()">✕</button>
        <button class="fs-nav fs-prev" onclick="prevFs()">‹</button>
        <button class="fs-nav fs-next" onclick="nextFs()">›</button>
        <div id="fsContent" style="width:100%; height:100%; display:flex; align-items:center; justify-content:center;"></div>
        <div class="fs-caption" id="fsCaption"></div>
    </div>

    <script>
        // --- DATA ---
        const defaultData = {
            'Joia': { type:'club', title: 'Iberostar Joia', sub: 'Eagle Beach', desc: 'Experience the crown jewel of Aruba.', gallery: ['Hotels/Joia/hotel_joia_1.jpg', 'Hotels/Joia/hotel_joia_2.jpg'], imageCount: 20 },
            'Tierra': { type:'club', title: 'Tierra del Sol', sub: 'Golf & Estates', desc: 'Escape to the islands most prestigious gated community.', gallery: ['Hotels/Tierra/golf_tierra_1.jpg'], imageCount: 20 },
            'Zima': { type:'food', title: 'Zima Rooftop Bar', sub: 'Joia Aruba', desc: 'Perched atop the Joia hotel.', gallery: ['Restaurants/Zima/rest_zima_1.jpg'], imageCount: 20 },
            'Bucatini': { type:'food', title: 'Bucatini', sub: 'Joia Aruba', desc: 'Modern Italian cuisine.', gallery: ['Restaurants/Bucatini/rest_bucatini_1.jpg'], imageCount: 20 },
            'Marea': { type:'food', title: 'Marea', sub: 'Joia Aruba', desc: 'Vibrant Caribbean flavors.', gallery: ['Restaurants/Marea/rest_marea_1.jpg'], imageCount: 20 },
            'Azzurro': { type:'food', title: 'Azzurro', sub: 'Seafood', desc: 'Authentic Italian seafood.', gallery: ['Restaurants/Azzurro%20Ristorante/rest_azzurro_1.jpg'], imageCount: 20 }
        };

        // --- GLOBAL STATE ---
        let appData = defaultData;
        let currentGallery = [];
        let currentImgIndex = 0;

        // --- INIT ---
        window.onload = function() {
            // FIX: Wait for layout to settle before removing splash
            // This prevents the "glitch/broken" look on load
            setTimeout(() => {
                document.getElementById('splash').style.opacity = '0';
                setTimeout(() => { 
                    document.getElementById('splash').style.display = 'none';
                    // Trigger animations after splash is gone
                    document.querySelector('.grid').classList.add('loaded');
                }, 800);
            }, 1000);

            // Initialize App
            updateTimeVibe();
            renderApp('portfolio');
            
            // Restore data if exists
            const saved = localStorage.getItem('ib_app_data');
            if(saved) { try { appData = JSON.parse(saved); } catch(e) {} }
        };

        function updateTimeVibe() {
            const hour = new Date().getHours();
            const body = document.body;
            const logo = document.getElementById('headerLogo');
            
            body.className = ''; // Reset
            if (hour >= 18 || hour < 6) {
                body.classList.add('dark-theme');
                document.getElementById('nightGlow').classList.add('glow-active');
                if(logo) logo.classList.add('logo-white');
                document.getElementById('greeting').innerText = "Bon Nochi";
            } else {
                if(logo) logo.classList.remove('logo-white');
                document.getElementById('greeting').innerText = "Bon Dia";
            }
            
            document.getElementById('dateDisplay').innerText = new Date().toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' });
        }

        function renderApp(sectionId) {
            const container = document.getElementById('appContent');
            const grid = document.createElement('div');
            grid.className = 'grid';
            
            const filterMap = { 'portfolio': 'club', 'dining': 'food', 'activities': 'fun', 'spa': 'spa', 'golf': 'golf' };
            const type = filterMap[sectionId];
            
            let html = '';
            Object.keys(appData).forEach(key => {
                const item = appData[key];
                if(item.type !== type) return;
                
                // Use first valid gallery image or main img
                const mainImg = (item.gallery && item.gallery.length > 0) ? item.gallery[0] : item.img;
                
                html += `
                <div class="card" onclick="openDetails('${key}')">
                    <div class="card-media">
                        <div class="tag-pill">${item.sub}</div>
                        <img class="card-img" src="${mainImg}" onload="imgLoaded(this)" onerror="handleImgError(this)">
                    </div>
                    <div class="card-content">
                        <h3 class="card-title">${item.title}</h3>
                        <p class="card-desc">${item.desc}</p>
                    </div>
                </div>`;
            });
            
            grid.innerHTML = html;
            container.innerHTML = '';
            container.appendChild(grid);
            
            // Trigger animation slightly after render
            setTimeout(() => grid.classList.add('loaded'), 50);
            
            // Update Nav State
            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
            const idx = ['portfolio','dining','activities','spa','golf'].indexOf(sectionId);
            if(idx > -1) document.querySelectorAll('.nav-btn')[idx].classList.add('active');
            
            // Toggle Search
            document.getElementById('searchBox').style.display = (sectionId === 'dining' || sectionId === 'activities') ? 'block' : 'none';
        }

        function nav(id) { renderApp(id); }

        function openDetails(key) {
            const item = appData[key];
            const modal = document.getElementById('detailModal');
            
            // Generate Full Gallery List (Theoretical)
            let galleryData = [];
            if (item.imageCount && item.imageCount > 0) {
                // Determine prefix from first image
                const mainSrc = item.gallery ? item.gallery[0] : item.img;
                if (mainSrc) {
                    const lastUnderscore = mainSrc.lastIndexOf('_');
                    const lastDot = mainSrc.lastIndexOf('.');
                    if (lastUnderscore > -1 && lastDot > -1) {
                        const prefix = mainSrc.substring(0, lastUnderscore + 1);
                        const ext = mainSrc.substring(lastDot);
                        for (let i = 1; i <= item.imageCount; i++) galleryData.push(prefix + i + ext);
                    } else {
                        galleryData = item.gallery || [item.img];
                    }
                }
            } else {
                galleryData = item.gallery || [item.img];
            }
            
            // Populate Modal
            document.getElementById('dTitle').innerText = item.title;
            document.getElementById('dSub').innerText = item.sub;
            document.getElementById('dDesc').innerText = item.desc;
            document.getElementById('dImg').src = galleryData[0];
            
            // Render Thumbnails
            const galContainer = document.getElementById('dGallery');
            let gHtml = '';
            // We give each image a data-src so we can retrieve it later
            galleryData.forEach((src, i) => {
                gHtml += `<div class="gallery-item" onclick="openLightboxFromThumb(this)">
                            <img src="${src}" onload="imgLoaded(this)" onerror="handleImgError(this)">
                          </div>`;
            });
            galContainer.innerHTML = gHtml;
            
            modal.classList.add('active');
        }

        function closeModal() { document.getElementById('detailModal').classList.remove('active'); }

        // --- NEW LIGHTBOX LOGIC ---
        // Instead of using the theoretical list (20 items), we scan the DOM for images that actually loaded.
        
        function getValidImages() {
            // Find all images in the gallery strip that are NOT hidden
            const imgs = document.querySelectorAll('#dGallery .gallery-item img');
            const validSrcs = [];
            imgs.forEach(img => {
                // If it wasn't removed by handleImgError and has src, it's valid
                if (img.src && img.style.display !== 'none') {
                    validSrcs.push(img.src);
                }
            });
            return validSrcs;
        }

        function openLightboxFromThumb(element) {
            const clickedSrc = element.querySelector('img').src;
            const validList = getValidImages();
            
            // Find index of clicked image in valid list
            let index = validList.indexOf(clickedSrc);
            if (index === -1) index = 0;
            
            launchLightbox(validList, index);
        }

        function openLightboxFromHero() {
            // If clicking hero, try to match hero src to valid list, else start at 0
            const heroSrc = document.getElementById('dImg').src;
            const validList = getValidImages();
            
            let index = validList.indexOf(heroSrc);
            if (index === -1) index = 0;
            
            launchLightbox(validList, index);
        }

        function launchLightbox(list, index) {
            currentGallery = list;
            currentImgIndex = index;
            updateFs();
            document.getElementById('fsViewer').classList.add('active');
        }

        function updateFs() {
            const src = currentGallery[currentImgIndex];
            document.getElementById('fsContent').innerHTML = `<img class="fs-image" src="${src}">`;
            document.getElementById('fsCaption').innerText = `${currentImgIndex + 1} / ${currentGallery.length}`;
        }

        function nextFs() {
            currentImgIndex++;
            if(currentImgIndex >= currentGallery.length) currentImgIndex = 0;
            updateFs();
        }

        function prevFs() {
            currentImgIndex--;
            if(currentImgIndex < 0) currentImgIndex = currentGallery.length - 1;
            updateFs();
        }

        function closeFs() {
            document.getElementById('fsViewer').classList.remove('active');
            document.getElementById('fsContent').innerHTML = '';
        }
        
        function filterContent() {
             const query = document.getElementById('searchInput').value.toLowerCase();
             document.querySelectorAll('.card').forEach(c => {
                 const t = c.querySelector('.card-title').innerText.toLowerCase();
                 c.style.display = t.includes(query) ? 'block' : 'none';
             });
        }
    </script>
</body>
</html>


